**Модуль 27. Практическая работа**

**Цель практической работы**

1. Освоить работу с PostgreSQL.
2. Научиться описывать настройки PostgreSQL.
3. Запускать СУБД с помощью Docker.
4. Попрактиковаться в работе с командой psql.
5. Работать с особенностями синхронного подключения к СУБД.
6. Научиться работать с миграциями с помощью Alembic.

**Что входит в работу**

- Описать docker-контейнеры.
- Поработать с особенностями синхронного подключения к PostgreSQL.
- Поработать с миграциями.


**Задание 1. Описание docker-контейнеров**

**Что нужно сделать**

1. Опишите docker-контейнер для flask
-приложения, развёрнутого с помощью Gunicorn с описанием network для взаимодействия с СУБД.
2 . Опишите docker-контейнер СУБД PostgreSQL с указанием настроек:
    - log_destination=stderr (направление логов в поток вывода ошибок);
    - logging_collector=on (включение сборщика логов из stderr в log-файлы);
    - log_directory (путь к директории, в которой будут лежать логи).

**Советы и рекомендации**

Не забудь про volume и env-переменные для работы с СУБД.

**Что оценивается**

Умение описывать docker-контейнеры для использования PostgreSQL и запускать СУБД с учётом кастомных настроек.

**Задание 2. Работа с особенностями синхронного подключения к PostgreSQL**

**Что нужно сделать**

1. Подключитесь к СУБД через psql и создайте базу данных skillbox_db, которая должна быть доступна юзеру, указанному в env-переменных.
2. С помощью метакоманд подключитесь к созданной базе данных и создайте таблицу test_psql_table.
3. Во flask-приложении с помощью ORM SqlAlchemy
 настройте соединение со skillbox_db и опишите модели пользователя и кофе, который предпочитает пить наш пользователь:

    ``` sql
    СREATE TABLE coffee (
        id SERIAL NOT NULL, 
        title VARCHAR(200) NOT NULL, 
        origin VARCHAR(200), 
        intensifier VARCHAR(100), 
        notes VARCHAR[], 
        PRIMARY KEY (id)
    )
    
    CREATE TABLE users (
        id SERIAL NOT NULL, 
        name VARCHAR(50) NOT NULL, 
        has_sale BOOLEAN, 
        address JSON, 
        coffee_id INTEGER, 
        PRIMARY KEY (id), 
        FOREIGN KEY(coffee_id) REFERENCES coffee (id)
    )
    ```
4. С помощью функции before_first_request
 создайте десять пользователей и десять сортов кофе. 
    - Для этого воспользуйтесь сервисом генерации тестового api
    -ответа — https://random-data-api.com. 
    - Для заполнения атрибута address у пользователей — https://random-data
    -api.com/api/address/random_address. 
     - Для кофе — https://random-data-api.com/api/coffee/random_coffee. 
    - Обработайте ответ получения кофе, где title=blend_name, origin=origin
    , notes=notes, intensifier=intensifier. 
    - Для пользователя поле name и связь с кофе заполните рандомно.
5. Создайте роуты для выполнения запросов (название не играет роли).
    - Добавление пользователя. В ответе должна быть информация по новому пользователю с его предпочтением по кофе.
    - Поиск кофе по названию (используйте [полнотекстовый поиск](https://docs.sqlalchemy.org/en/14/dialects/postgresql.html#full-text-search), название — входной параметр). 
    - Список уникальных элементов в заметках к кофе. 
    - Список пользователей, проживающих в стране (страна — входной параметр).

**Советы и рекомендации**

Обратите внимание на типы данных атрибутов coffee.notes — ARRAY, users
.address — JSON. Ознакомьтесь со [статьёй](https://postgrespro.ru/docs/postgrespro/9.5/datatype-textsearch) по поводу текстового поиска. 

**Что оценивается**

- Понимание работы с особенностями PostgreSQL через SqlALchemy.
- Работа с новыми типами данных.

**Задание 3. Работа с миграциями**

**Что нужно сделать:**

1. Подключите к проекту Alembic.
2. Создайте init-миграцию и накатите её.
3. Создайте и накатите миграцию по удалению атрибута user.has_sale.
4. Откатите миграцию из п. 3.
5. Создайте и накатите миграцию по добавлению атрибута user.surname.
6. Сделайте имитацию конфликтной ситуации: создайте миграцию по добавлению user.patronomic, в атрибуте down_revision укажите миграцию из п. 2.
7. Накатите миграцию из п. 6 и решите конфликт.


**Что оценивается**

Понимание, как работать с инструментом для миграции БД — Alembic, работа с накатыванием и отменой миграций.

**Как отправить работу на проверку**

Выполните домашнее задание в GitLab, в форме ниже напишите «Сделано» и нажмите кнопку «Отправить».



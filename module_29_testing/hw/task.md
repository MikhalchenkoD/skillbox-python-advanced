**Модуль 29. Практическая работа**

**Цель практической работы**

1. Научиться писать unit-тесты.
2. Научиться использовать фикстуры, маркеры. 
3. Применить интеграционное тестирование, используя Factory Boy и Faker.


**Что входит в работу**

- Подготовить ORM-модели, API для тестирования.
- Описать фикстуры для unit-тестов.
- Протестировать API.
- Протестировать взаимодействие с БД.

**Кейс**

Представим, что вы работаете в стартапе, который создаёт новый способ оплаты парковки: клиенту необходимо зарегистрироваться в приложении, указать карту для оплаты и свой автомобиль. Когда автомобиль подъезжает к парковке, камеры считывают его номер, и, если есть свободные места, поднимается шлагбаум. При выезде также считывается номер автомобиля, определяется количество времени парковки и автоматически списываются средства с карты для оплаты. Никаких охранников и терминалов — всё в вашем телефоне.
Сейчас команда занимается проектированием БД и описанием методов API для работы с камерами, шлагбаумом и мобильным приложением клиентов. 


**Задание 1. Описание ORM-модели**

Базу спроектировали так:

```sql
CREATE TABLE client (
            id INTEGER NOT NULL, 
            name VARCHAR(50) NOT NULL, 
            surname VARCHAR(50) NOT NULL, 
            credit_card VARCHAR(50), 
            car_number VARCHAR(10), 
            PRIMARY KEY (id)
)
CREATE TABLE parking (
            id INTEGER NOT NULL, 
            address VARCHAR(100) NOT NULL, 
            opened BOOLEAN, 
            count_places INTEGER NOT NULL, 
            count_available_places INTEGER NOT NULL, 
            PRIMARY KEY (id)
)
CREATE TABLE client_parking (
            id INTEGER NOT NULL, 
            client_id INTEGER, 
            parking_id INTEGER, 
            time_in DATETIME, 
            time_out DATETIME, 
            PRIMARY KEY (id), 
            CONSTRAINT unique_client_parking UNIQUE (client_id, parking_id), 
            FOREIGN KEY(client_id) REFERENCES client (id), 
            FOREIGN KEY(parking_id) REFERENCES parking (id)
)
```
**Что нужно сделать**

1. Создайте Flask-приложение, используя Application Factory.
2. Опишите ORM-модели клиента, парковки и лога въезда-выезда с парковки, 
   используя flask_sqlalchemy.

**Рекомендации**

Используйте отложенную инициализацию (init_app) объекта Sqlalchemy().

**Что оценивается**

Умение работать с ORM, используя flask_sqlalchemy, и создавать приложение через функцию create_app, используя фабрику. 

**Задание 2. Описание API**

**Что нужно сделать**

Создайте роуты:
1. GET /clients — список всех клиентов.
2. GET /clients/<client_id> — информация клиента по ID.
3. POST /clients — создать нового клиента.
4. POST /parkings — создать новую парковочную зону.
5. POST client_parkings — заезд на парковку (проверить, открыта ли парковка, 
   количество свободных мест на парковке уменьшается, фиксируется дата заезда). В теле запроса передать client_id, parking_id.
6. DELETE client_parkings — выезд с парковки (количество свободных мест 
   увеличивается, проставляем время выезда). В теле запроса передать client_id, parking_id. 

**Рекомендации**

При заезде на парковку не забывайте проверять наличие свободных мест, при выезде — производить оплату (проверьте, что у клиента привязана карта).

**Что оценивается**

Создание полноценного API.

**Задание 3. Тестирование API с использованием pytest**

**Что нужно сделать**

1. Создайте фикстуры в файле conftest.py:
- app — приложение, внутри фикстуры опишите создание тестового клиента, 
   парковки и парковочного лога с фиксацией времени въезда и выезда.
- client — клиент, для запросов к приложению.
- db — для работы с БД. 
2. Напишите тесты:
   1. Используя @pytest.mark.parametrize, проверьте, что все GET-методы 
   возвращают код 200. 
   2. Создание клиента. 
   3. Создание парковки. 
   4. Заезд на парковку. 
   5. Выезд с парковки.
3. Добавьте маркер parking для тестов «Заезд на парковку» и «Выезд с парковки».

**Рекомендации**

Не забудьте проверить соответствующие атрибуты: при заезде клиента, открыта ли парковка, количество свободных мест на парковке уменьшается, при выезде увеличивается, время выезда не может быть меньше времени заезда, при оплате — у клиента привязана карта.
Можете придумать свои тесты, при проверке это будет только приветствоваться :)

**Что оценивается**

Умение писать фикстуры и использовать их в тестах. Понимание, как правильно писать тесты.

**Задание 4. Работа с Factory Boy и Faker**

**Что нужно сделать**
1. Создайте фабрику ClientFactory:
   1. name — генерация first_name. 
   2. surname — генерация last_name. 
   3. credit_card — либо нет карты, либо она есть. 
   4. car_number — генерация текста. 
2. Создайте фабрику ParkingFactory:
   1. address — генерация адреса. 
   2. opened — либо True, либо False. 
   3. count_places — генерация Int. 
   4. count_available_places — LazyAttribute.
3. Сделайте дубликат теста «Создание клиента» из задания 3 и перепишите его, 
      используя ClientFactory.
4. Сделайте дубликат теста «Создание парковки» из задания 3 и перепишите его, 
   используя ParkingFactory.

**Рекомендации**

При проверке можно проверять наличие ID у новых записей и изменение количества строк в таблицах.

**Что оценивается**

Работа с библиотеками для генерации данных.
Описание класса Meta для конфигурации фабрик.
Использование различных сущностей Factory Boy.

**Как отправить работу на проверку**

Выполните работу в GitLab, напишите «Сделано» в форме ниже и нажмите кнопку «Отправить».
